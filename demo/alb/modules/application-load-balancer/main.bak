# modules/application-load-balancer/main.tf

variable "alb_name" {
  description = "Name of the Application Load Balancer"
  type        = string
}

variable "target_group_name" {
  description = "Name of the target group"
  type        = string
}

variable "listener_port" {
  description = "Port for the ALB listener"
  type        = number
}

variable "listener_protocol" {
  description = "Protocol for the ALB listener"
  type        = string
}

variable "container_name" {
  description = "Name of the container to attach to the target group"
  type        = string
}

variable "container_port" {
  description = "Port of the container to attach to the target group"
  type        = number
}

variable "alb_security_group_id" {
  description = "Security group ID for the ALB"
  type        = string
}

variable "alb_subnet_id" {
  description = "Subnet ID for the ALB"
  type        = string
}

variable "vpc_id" {
  description = "VPC ID"
  type        = string
}

resource "aws_lb" "application_load_balancer" {
  name               = var.alb_name
  internal           = false
  load_balancer_type = "application"
  security_groups    = [var.alb_security_group_id]

  subnet_mapping {
    subnet_id = var.alb_subnet_id
  }

  vpc_id = "vpc-3a9b1451"
}

resource "aws_lb_listener" "application_listener" {
  load_balancer_arn = aws_lb.application_load_balancer.arn
  port              = var.listener_port
  protocol          = var.listener_protocol

  default_action {
    type             = "forward"
    target_group_arn = aws_lb_target_group.application_target_group.arn
  }
}

resource "aws_lb_target_group" "application_target_group" {
  name     = var.target_group_name
  port     = var.container_port
  protocol = var.listener_protocol
  vpc_id   = var.vpc_id
}

resource "aws_lb_target_group_attachment" "application_target_group_attachment" {
  target_group_arn = aws_lb_target_group.application_target_group.arn
  target_id        = var.container_name
  port             = var.container_port
}

